<!DOCTYPE html>
<html>
<!-- header_start -->
<head>
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>140文字以上</title>
<!--
	<link rel="icon" type="image/x-icon" href="https://chromabox.github.io/140m/css/favicon.ico">
	<link rel="apple-touch-icon" sizes="180x180" href="https://chromabox.github.io/140m/css/apple-touch-icon-180x180.png">
-->
	<script type="text/javascript">
	if ((navigator.userAgent.indexOf('iPhone') > 0 && navigator.userAgent.indexOf('iPad') == -1) || navigator.userAgent.indexOf('iPod') > 0 || navigator.userAgent.indexOf('Android') > 0) {
		document.write('<link rel="stylesheet" type="text/css" href="https://chromabox.github.io/140m/css/style_smt.css">');
	}else {
		document.write('<link href="https://fonts.googleapis.com/css?family=M+PLUS+1p:300,400&amp;subset=japanese" rel="stylesheet">');
		document.write('<link rel="stylesheet" type="text/css" href="https://chromabox.github.io/140m/css/style_pc.css">');
	}
	</script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/solid.css" integrity="sha384-QokYePQSOwpBDuhlHOsX0ymF6R/vLk/UQVz3WHa6wygxI5oGTmDTv8wahFOSspdm" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/brands.css" integrity="sha384-n9+6/aSqa9lBidZMRCQHTHKJscPq6NW4pCQBiMmHdUCvPN8ZOg2zJJTkC7WIezWv" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/fontawesome.css" integrity="sha384-vd1e11sR28tEK9YANUtpIOdjGW14pS87bUBuOIoBILVWLFnS+MCX9T6MMf0VdPGq" crossorigin="anonymous">
	<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="https://chromabox.github.io/140m/css/common_style.css">
</head>
<!-- header_end -->

<!-- body_start -->
<body>

<!-- title_start -->
<div id="blog-title-bx">
  <div id="blog-title-content">
	<h1 id="blog-title-font">
	<a href="https://chromabox.github.io/140m/">140文字以上</a>
	</h1>
  <div id="blog-subtitle-content">
	<h4 id="blog-subtitle-font">
	<p>140文字では伝わらないことを書いています。禁無断転載</p>
    <p><a href="https://twitter.com/chromarock">twitter(@chromarock)</a>、<a href="https://github.com/chromabox">github</a>、<a href="https://www.amazon.jp/hz/wishlist/ls/2IWGNZS26U41G?ref_=wl_share">ほしいものリスト</a>、<a href="https://chromabox.github.io/140m/txt/profile.html">その他プロフィール</a></p>
	</h4>
  </div>
  </div>
</div>
<div id="title-content-line"></div>
<!-- title_end -->


<!-- content_start -->
<div id="content-bx">

<!-- header_box_start -->
<header class="header-box">
<!-- entry_time_start -->
	<h4 class="entry-time-title"><i class="fa fa-clock"></i> 2019/09/06</h4>
<!-- entry_time_end -->
<!-- entry_name_start -->
	<h1 class="entry-title"><a href="https://chromabox.github.io/140m/txt/board/stm32/20190906_stm32/">STM32 NucleoボードのST-Linkを切り離してみた</a></h1>
<!-- entry_name_end -->
<!-- entry_category_start -->
	<div class="entry-categories categories"><a href="https://chromabox.github.io/140m/txt/board/stm32/index.html" class="entry-category-link">STM32関連</a>
<!-- entry_category_end -->
</header>
<!-- header_box_end -->

<div class="main-box-spacer"></div>

<!-- main_box_start -->
<div class="main-box">
<p>はい、以下は電子工作系の話です</p>
<p>某要件でSTM32Fほにゃらら(アレなんで伏せておきます)が乗っているNucleoというボードを使って色々しているわけですが、ここにきて動かしていると急にボードのリセットが掛かるという現象が起こり、このままでは開発もままならなくなったので、ついつい手が滑ってこのNucleoボードの上部に乗っかってるST-Linkというボードを切り離してしまった話です。</p>
<p>※闇雲にSTLinkが悪いんだって切ったというわけではなくて、回路図とにらめっこしながら、あるWindowsPCでST-Linkを活性化している場合に起こりやすいというところからどうもこいつがNRSTのレベル下げたり、各種いらんことをしているのでは？？という推論に基づいています。推論したら実行に移さないと気がすまないってのもあります。</p>
<BR>
<p>Nucleo-144系ボードの話はまだそんなにネットになかったので、ネタになるかなと思い、以下、載せておきます。</p>

<div class="content-2-box">
<div class="content-2-title"><h3>STLinkと本体との切り離し</h3></div>
<p>
何はともあれ、まずはNucleoさんの基板の上にくっついてるSTLinkとSTM32Fが居る本体部分を物理的に切り離さないと進みません。</p>
<p>
切り離す前はこんな感じになってます。<br>
<img src="01.jpg"><br>
上部がST-linkですね。橋みたいなので繋がっておりますね。<br>
一見何もなさそうですが、実は多層基板になっていて、この橋から本体にUSBからの電源供給線や、リセットやらSWDIOやらの各種信号が繋がっております。<br>
STのマニュアルには<b>「STLinkを外したい愚か者はこの橋を切断せよ」</b>みたいなことがかいてあります…</p>
<p>
ということで、ボクは当初カッターナイフで切ろうとしたのですが、思いの外大変だったので、釣りの時に使う、凍ったアミコマセを小分けする用途に100均で買った棒ノコみたいなので切りました。</p>
<p>
<img src="02.jpg"><br>
切ったらこうなります。さすがに棒ノコだと簡単に切れますね。<br>
あとはバリをヤスリで削ったら第一工程終わり。<br>
なお、外したSTLinkは使えなくなってジャンク扱いになるの？？といえばそんなことはなくて、今後も外部デバッガとして利用できます。よかったですね。<br>
つまり、Nucleoボードをスイッチサイエンスさんとか、秋月さんとかで買うなり、何らかの手段で手に入れればハードウェア接続なデバッガも付いてくるわけですな。ええ時代や…
</p>
</div>

<div class="content-2-box">
<div class="content-2-title"><h3>チップ抵抗外しと、ソケット実装と…</h3></div>
<p>
これで終わりだったらとっても楽だったのですが、そうは問屋が卸さないという感じで、ST-Linkを外してしまった愚か者には罰があるのです。。。</p>
<p>
回路図見たら「あっ、、、」ってわかるのですが、ST-Linkから供給されているMCOという外部高速クロック(8Mhz)が、ST-Linkを外してしまうことによって供給されなくなります。</p>
<p>
まあ別にSTのチップは外部からクロックを供給されなくても最悪自分自身でクロックを供給できるようにはなってるのですが、USBデバイスとして機能させる場合など正確な高速クロックが必要な場合は、何らかの手段で外からクロックを供給しなくてはいけないみたいです。
</p>
<p>
今回の事案もUSBデバイスとして利用するというのがあったので、何らかの手段でクロックを供給せねばなりませんでした。<BR>
ということで、STのマニュアルには以下のように書いてあります。<BR>
<img src="manual01.jpg"><BR>
つまり、今までST-Link基板が繋がってるときはオレンジで書いてある設定だったけど、外すと赤色で囲った設定にしないといけないよ…ということです。</p>
<p>
回路図見るとこんな感じですね。<BR>
<img src="manual02.jpg"><BR>
SB149は0抵抗で繋がってるのでこれを外します。<BR>
で、SB8と9は未実装になっているので、何らかの手段でブリッジします。<BR>
X3に普通の水晶振動子を使用する場合は、C37と38に所定のコンデンサを接続する必要があるのですが…まぁコレ見てくださいよ
<img src="x3.jpg"><BR>
工作しなきゃいけないのは、赤で囲ったところですね。<BR>
写真では拡大して映しているので「ふーん」って感じですが、実際はかなり小さいです。<BR>
正直、ここに砂粒みたいなチップコンデンサを付ける自信というか腕は皆無だったので、実はコンデンサ不要(実は内蔵されている)のセラロックというセラミック振動子(振動器かも)を使って逃げることにしました。<BR>
セラロックはコンデンサを付けなくても良いのですが、GNDと接続する必要はあるのでC37が乗るであろうパターンのGNDパターンに接続しようという形になりました。
</p>
<p>
ということで、まずは0Ωなチップ抵抗を外す作業から…<BR>
といっても、チップ抵抗をどうにかするのは久しぶりで、ましてや外した作業なんてしたことがなく、これは練習が必要だなぁと思い、、切り取ったST-Linkの基板で練習…(切り取ってしまえば外す意味はあまりないのですが、こいつをST-Linkデバッガとして新しく活用したい場合は、ノイズ云々の理由で一応外す必要があるそうです)<BR>
</p>
<p>
最初は使い慣れているこのハンダこて(15w)で作業しようと思ってました…<br>
<img src="03.jpg"><br>
ところが、、、いざチップ抵抗を外す作業となるとどう頑張ってもこいつでは外せないことが判明。<br>
<br>
なんでだろうなあ〜と思ってネットを調べていると、どうやら<b>「ハンダを流しつつ、両方の端子を同時に温めないと取れない」</b>という事がわかり、えっそれって<b>合体前に同時に弾を打ち込まないと壊せないスターソルジャーのラザロ</b>みたいじゃないか…と早速難問が立ちはだかります。。。</p>
<p>
いやぁさすがにヒートガンは持ってないし、世の中の人はどうしてんだろうなあと思ってYoutubeを漁ってると良い動画を見つけました。<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/26VgQ2hKclw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><BR>
ようは、<B>ヘラ状のコテ先を使えば同時に暖められる</b>じゃんという発想ですね。<BR>
これを発見したときは「はぁ〜こんな方法があるのかぁ。。。これなら他の部品温めて死ぬ事無いしキレイだし凄いなぁ。。。」と目から鱗が瀧のように流れました……
</p>
<p>
ということで、流石にヘラ状のコテ先は持ってなかったので、ホームセンターに無いかなと探しに行きました。
そしたら奇跡的に以下の商品があり、迷わず購入。<br>
<img src="04.jpg"><br>
20wでコテ先が色々入ってました。ハンダ付け用のとかヒートカッターとか色々入って2000円くらい。<br>
お子様向けみたいなことが書いてありましたが、小さくて使いやすそうで、細かい電子工作にも良いんじゃないかなと。<br>
</p>

<p>
それで、コテ先はヘラ状のも入ってたので装着して当ててみると、狙ったようににピッタリ<BR>
<img src="05.jpg"><BR>
<BR>
こりゃいけるぞ…ということで、温めつつ新しいハンダを流すとやっとチップ抵抗が取れました<BR>
<img src="06.jpg"><BR>
</p>
<p>
なお、パスコン(VCCとGNDに挟まってる安定用のコンデンサ)との比較画像はこんな感じです<br>
<img src="07.jpg"><br>
本当に米粒というか砂粒なのが解ると思います。<br>
我々が普段手にしているスマホにはこういうのがそりゃもう沢山入っております。
</p>

<p>
取った後のST-link基板はこんな感じになりました<br>
<img src="08.jpg"><br>
SB110〜112に付いてたチップ抵抗を外しました。外した直後はハンダのペースト(ヤニ)がついてて茶色いですが、爪でガリガリするなりアルコールかなんかで拭き取るとキレイにとれます。<BR>
</p>

<p>
ST-link基板で修行を積んだので、本チャンと行きます。赤で囲った部分がターゲットです。<br>
<img src="09.jpg"><br>
SB149は周囲に部品が無いのでまだ余裕。<BR>
SB163は近所にコンデンサがあり、ここに誤爆して外した抵抗と合体したりすると本当にダメなので、反対側のSB160は巻き添えにしても良いように方向を考えて作業しました。
</p>
<p>
やはりSB163はボクには難問鬼門で、以下画像にも格闘の跡が見えておりますが、、、なんとか除去成功。<BR>
<img src="10.jpg"><br>
テスターでチェックして問題ないことを確認。これで第二関門クリア<br>
</p>

<p>
そしていよいよ最大にして一番むずかしい発振器周りです。<BR>
どのようにつなげるかは以下の通り。<BR>
<img src="x3_2.jpg"><br>
スペース的にも正直なかなかキツイですがやっていくしかありません。<BR>
なお、「セラ8Mhz」と書いてあるのはセラロック8Mhzでして、実物これです。<BR>
<img src="12.jpg"><br>
セラロックは一応極性というか向きはあるそうで、2はGNDに接続しないといけないのは当然として、1はCPU側のOSC_OUT、3はOSC_INに接続しないといけないです。
OUTに1を接続するとかなんとも不思議な感覚になりますが、そうしないと波形がズレてしまうらしいですはい。<BR>
参考→<A href="https://www.murata.com/ja-jp/support/faqs/products/timingdevice/ceralock/mnt/cch0007">逆方向に実装した場合、問題が発生しますか？｜村田製作所</a>
</p>
<p>
8Mhzから変えることはあまりないと思いたいけど、もしかしたらもあるから一応簡単に付け替えられるようにしておこうと思い、ソケットを付けて色々実装頑張ったらこうなりました。<BR>
<img src="11.jpg"><br>
</p>
<p>
ちなみに、配線はこれを使ってます。秋葉にある秋月電子さんやら千石電子さんに売ってますし、大阪だと多分デジットなんかにあるかなーと。<br>
<img src="haisen.jpg"><br>
むき出しのように見えて、実はポリウレタンで薄く皮膜してあります。<br>
皮膜してあるので普段は導通しないわけです<br>
なお、皮膜はハンダの熱で溶解して中の銅線と導通可能になるので、作業前に線をメッキハンダ(線にハンダを付ける作業)をするだけで良いということに。<br>
つまり、ワイヤーストリッパーなどでビニールを剥くといった作業をしなくて良いわけですね。<br>
とっても細かいランドに信号線を飛ばさないといけない時やら、数こなさないといけないバスラインを接続する場合にすごく重宝します…というかこれじゃないとあたしゃ無理ですわ正直。<BR>
</p>

<p>
若干話それましたが、最終的にソケットにセラロックを収めてこうなりました。<BR>
<img src="13.jpg"><br>
テスターで確認して問題なければこれにて終わりです。
</p>
<p>
あ、あと電源もST-linkから供給されなくなったので、どうにかする必要は有ります。<BR>
ボクはUSBケーブルを剥いてE5Vにその電源を入れることにしました。<BR>
E5VはCN11端子に出ております。この辺はまあ解説しても面白くないので略。<BR>
<BR>
シリアルもUSART3から他になってしまうので、シリアル出したい場合はこの辺りも考える必要は有ります。USART3はCN11とかにも出てますが、USART3は何をトチ狂ったかTXとRXが遠すぎる(CN11と12にまたがってる…)ので、CN9にまとまって出てるUSART2を活用すればスマートにできます。<BR>
<BR>
</div>

<div class="content-2-box">
<div class="content-2-title"><h3>ソフト側の変更など…</h3></div>
<p>
このままでも動くことは動くのですが、このままではクロック設定に失敗して内部クロックを勝手に使うことになって苦労して付けた意味がなくなってしまうので、ソフトも若干の変更が必要になります。<BR>
多分ST提供のIDE(CubeMXなど)を使ってるとNucleoのデフォルト設定だとMCOが生きている状況で、直接方形波のクロックが入ることになるので、HSEはMCOを使う設定になってます。<BR>
セラロックから出てくる波形は方形波じゃなくて純粋な波なので、これを教えないといけません。</p>
<p>
ソフト面での変更方法ですが、CubeMXのGUIではHSEの設定がBypassになってるはずなので、それを変更するか、もしくはソースの以下行
<pre class="code_font codebox">
<div class="code_filebox">Src/main.c</div>
  RCC_OscInitStruct.HSEState = RCC_HSE_BYPASS;
</pre>
を
<pre class="code_font codebox">
<div class="code_filebox">Src/main.c</div>
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
</pre>
に変えればOKです。<br>
これをビルドし直して焼けばOK。</p>
<p>
あと、USART2使う人はそれ用の変更するなどですね。<br>
</p>
</div>

<div class="content-2-box">
<div class="content-2-title"><h3>まとめなど</h3></div>
<p>
ということでブログにすると長くなりましたが、作業は実際半日かかってしまいました。<br>
なお、無事にクロックも供給できて、USBデバイスのテストアプリを焼いて無事に動くことを確認しましたので、同じ症状で困ってる人の参考になればと…</p>
<p>
後日、切り離したSTLinkを使ってみましたが、どうやらNRSTを接続すると不意に信号がローに落ちる場合があるようで(NRSTは負論理なのでしばらくローになるとリセットが掛かったということになります)、レアを引いてしまったか、もしくはST-Linkを接続している自分のPCとの相性が不味いのか…といった感じです。<BR>
同じ症状が無いかと思い、ネットを漁ってると一部のUSB3.0ホストとの相性が良くないらしいというのを見かけたりもして、どうかなーといったところ。<BR>
他の会社のデバッガを実は持っていて、こいつはNRST繋げてもこういった状況にはならずサクサクイケるので、まあこれでいいかーということに落ち着きました。
</p>
</div>


<!-- footer_start -->
<div class="main-box-spacer"></div>
<div class="twitter">
<a href="//twitter.com/share" class="twitter-share-button" data-text="140文字以上：STM32 NucleoボードのST-Linkを切り離してみた" data-url="https://chromabox.github.io/140m/txt/board/stm32/20190906_stm32/" data-lang="ja"></a>
</div>
<!-- footer_end -->
</div>
<!-- main_box_end -->

</div>
<!-- content_end -->
</body>
<!-- body_end -->
</html>
